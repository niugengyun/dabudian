<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Â§ß‰∏çÁÇπ</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }
        /* Â∑¶‰æßÊåâÈíÆÊ†èÊ†∑Âºè */
        .sidebar {
            width: 64px;
            height: 100%;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            box-shadow: 1px 0 5px rgba(0, 0, 0, 0.1);
        }
        .sidebar-btn {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            border-radius: 12px;
            border: none;
            background-color: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        .sidebar-btn:hover {
            background-color: #e6f7ff;
            transform: translateY(-2px);
        }
        .sidebar-btn:active {
            transform: translateY(0);
        }
        .sidebar-icon {
            font-size: 20px;
            margin-bottom: 0;
        }
        .sidebar-text {
            font-size: 12px;
            color: #333;
        }
        /* Âè≥‰æßÂÜÖÂÆπÂå∫ÂüüÊ†∑Âºè */
        .content {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        /* Ê†áÁ≠æÈ°µÂÆπÂô® */
        .tabs-container {
            display: flex;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
            height: 40px;
            align-items: center;
            padding: 0 8px;
        }
        /* Ê†áÁ≠æÈ°µ */
        .tab {
            display: flex;
            align-items: center;
            padding: 0 12px;
            height: 32px;
            background-color: #e0e0e0;
            border-radius: 6px 6px 0 0;
            margin-right: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            white-space: nowrap;
            max-width: 160px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .tab.active {
            background-color: #fff;
            font-weight: 500;
        }
        .tab-close {
            margin-left: 8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }
        .tab-close::before {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' stroke='white' stroke-width='2'%3E%3Cpath d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        .tab-close:hover {
            background-color: #999;
        }
        /* Êñ∞Â¢ûÊ†áÁ≠æÊåâÈíÆ */
        .new-tab {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
            cursor: pointer;
            font-size: 16px;
            color: #666;
        }
        .new-tab:hover {
            background-color: #ddd;
        }
        /* Webview ÂÆπÂô® */
        .webview-container {
            flex: 1;
            position: relative;
        }
        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 300px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            border-bottom: 1px solid #e8e8e8;
            padding-bottom: 8px;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }
        .form-item {
            margin-bottom: 16px;
        }
        .form-item label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }
        select {
            width: 100%;
            height: 32px;
            padding: 4px 11px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
        }
        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
        }
        .btn {
            height: 32px;
            padding: 4px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            border: 1px solid #d9d9d9;
            background: white;
            color: rgba(0, 0, 0, 0.88);
            font-size: 14px;
        }
        .btn:hover {
            border-color: #4096ff;
            color: #4096ff;
        }
        .btn-primary {
            background: #1677ff;
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background: #4096ff;
            color: white !important;
            border: none;
        }
        .webview-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
        }
        .webview-wrapper.active {
            display: block;
        }
        .webview {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <!-- Â∑¶‰æßÊåâÈíÆÊ†è -->
    <div class="sidebar">
        <button class="sidebar-btn" id="addButton">
            <span class="sidebar-icon">+</span>
            <span class="sidebar-text">Ê∑ªÂä†</span>
        </button>
        <button class="sidebar-btn" id="serviceButton">
            <span class="sidebar-icon">üë®‚Äçüíª</span>
            <span class="sidebar-text">ÂÆ¢Êúç</span>
        </button>
        <button class="sidebar-btn" id="settingsButton">
            <span class="sidebar-icon">‚öôÔ∏è</span>
            <span class="sidebar-text">ËÆæÁΩÆ</span>
        </button>
        <button class="sidebar-btn" id="aboutButton">
            <span class="sidebar-icon">‚ÑπÔ∏è</span>
            <span class="sidebar-text">ÂÖ≥‰∫é</span>
        </button>
    </div>
    
    <!-- Âè≥‰æßÂÜÖÂÆπÂå∫Âüü -->
    <div class="content">
        <!-- Ê†áÁ≠æÈ°µÊ†è -->
        <div class="tabs-container" id="tabsContainer">
            <!-- ËøôÈáåÂ∞ÜÂä®ÊÄÅÊ∑ªÂä†Ê†áÁ≠æÈ°µ -->
            <div class="new-tab" id="newTabButton">+</div>
        </div>
        
        <!-- Webview ÂÆπÂô® -->
        <div class="webview-container" id="webviewContainer">
            <!-- ËøôÈáåÂ∞ÜÂä®ÊÄÅÊ∑ªÂä† webview -->
        </div>
    </div>

    <script>
        console.log('‰∏ªÁ™óÂè£Â∑≤Âä†ËΩΩ');
        
        // ÂÖ®Â±ÄÂèòÈáè
        let tabCounter = 0;
        let tabs = [];
        let activeTabId = null;
        
        // Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÊ≥®ÂÜåÁõëÂê¨Âô®
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('‰∏ªÁ™óÂè£ DOM Âä†ËΩΩÂÆåÊàê');
            
            // ‰ΩøÁî® preload Êö¥Èú≤ÁöÑ API
            if (window.electronAPI) {
                console.log('electronAPI ÂèØÁî®');
                
                // Âä†ËΩΩÊåÅ‰πÖÂåñÁöÑÊ†áÁ≠æÈ°µÊï∞ÊçÆ
                const tabsData = await window.electronAPI.loadTabsData();
                console.log('Âä†ËΩΩÂà∞ÁöÑÊ†áÁ≠æÈ°µÊï∞ÊçÆ:', tabsData);
                
                // Â¶ÇÊûúÊúâÊåÅ‰πÖÂåñÁöÑÊ†áÁ≠æÈ°µÊï∞ÊçÆÔºåÂàõÂª∫ÂØπÂ∫îÁöÑÊ†áÁ≠æÈ°µ
                if (tabsData && tabsData.tabs && tabsData.tabs.length > 0) {
                    tabsData.tabs.forEach(tab => {
                        createTabFromData(tab);
                    });
                }
                
                // ÁõëÂê¨Ê†áÁ≠æÈ°µÊ∑ªÂä†‰∫ã‰ª∂
                window.electronAPI.onTabAdded((tab) => {
                    console.log('Êî∂Âà∞Êñ∞Ê†áÁ≠æÈ°µÊï∞ÊçÆ:', tab);
                    createTabFromData(tab);
                });
                
                // ÁõëÂê¨Ê†áÁ≠æÈ°µÂà†Èô§‰∫ã‰ª∂
                window.electronAPI.onTabRemoved((tabId) => {
                    console.log('Êî∂Âà∞Ê†áÁ≠æÈ°µÂà†Èô§‰∫ã‰ª∂:', tabId);
                    removeTab(tabId);
                });
                
                // ÁõëÂê¨Ê†áÁ≠æÈ°µÊõ¥Êñ∞‰∫ã‰ª∂
                window.electronAPI.onTabUpdated((tab) => {
                    console.log('Êî∂Âà∞Ê†áÁ≠æÈ°µÊõ¥Êñ∞‰∫ã‰ª∂:', tab);
                    updateTab(tab);
                });

                // ÁõëÂê¨ÂØºËà™Âà∞‰∏ªÈ°µ‰∫ã‰ª∂
                window.electronAPI.onNavigateToHome(() => {
                    console.log('Êî∂Âà∞ÂØºËà™Âà∞‰∏ªÈ°µ‰∫ã‰ª∂');
                    const webview = document.getElementById(activeTabId);
                    if (webview) {
                        webview.src = 'https://zs.kwaixiaodian.com/page/helper?from=seller_pc_home_page';
                    }
                });

                // ÁõëÂê¨Âà∑Êñ∞Ê†áÁ≠æÈ°µ‰∫ã‰ª∂
                window.electronAPI.onRefreshActiveTab(() => {
                    console.log('Êî∂Âà∞Âà∑Êñ∞Ê†áÁ≠æÈ°µ‰∫ã‰ª∂');
                    const webview = document.getElementById(activeTabId);
                    if (webview) {
                        webview.reload();
                    }
                });

                // ÁõëÂê¨Ë∞ÉËØïÊ®°ÂºèÂàáÊç¢‰∫ã‰ª∂
                window.electronAPI.onToggleDebugMode(() => {
                    console.log('Êî∂Âà∞ÂàáÊç¢Ë∞ÉËØïÊ®°Âºè‰∫ã‰ª∂');
                    const webview = document.getElementById(activeTabId);
                    if (webview) {
                        if (webview.isDevToolsOpened()) {
                            webview.closeDevTools();
                        } else {
                            webview.openDevTools();
                        }
                    }
                });

                // ÁõëÂê¨ÊòæÁ§∫ÈÄÄÂá∫Ê®°ÊÄÅÊ°Ü‰∫ã‰ª∂
                window.electronAPI.onShowLogoutModal(() => {
                    console.log('Êî∂Âà∞ÊòæÁ§∫ÈÄÄÂá∫Ê®°ÊÄÅÊ°Ü‰∫ã‰ª∂');
                    showLogoutModal();
                });

                // ÁõëÂê¨ÊòæÁ§∫ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü‰∫ã‰ª∂
                window.electronAPI.onShowSettingsModal(() => {
                    console.log('Êî∂Âà∞ÊòæÁ§∫ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü‰∫ã‰ª∂');
                    showSettingsModal();
                });
            } else {
                console.error('electronAPI ‰∏çÂèØÁî®');
            }

            // Ê∑ªÂä†Êñ∞Ê†áÁ≠æÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            document.getElementById('newTabButton').addEventListener('click', () => {
                if (window.electronAPI) {
                    window.electronAPI.sidebarAction('add');
                }
            });

            // Ê∑ªÂä†ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            document.getElementById('addButton').addEventListener('click', () => {
                console.log('ÁÇπÂáªÊ∑ªÂä†ÊåâÈíÆ');
                if (window.electronAPI) {
                    window.electronAPI.sidebarAction('add');
                }
            });

            document.getElementById('serviceButton').addEventListener('click', () => {
                console.log('ÁÇπÂáªÂÆ¢ÊúçÊåâÈíÆ');
                if (window.electronAPI) {
                    window.electronAPI.sidebarAction('service');
                }
            });

            document.getElementById('settingsButton').addEventListener('click', () => {
                console.log('ÁÇπÂáªËÆæÁΩÆÊåâÈíÆ');
                if (window.electronAPI) {
                    window.electronAPI.sidebarAction('settings');
                }
            });

            document.getElementById('aboutButton').addEventListener('click', () => {
                console.log('ÁÇπÂáªÂÖ≥‰∫éÊåâÈíÆ');
                if (window.electronAPI) {
                    window.electronAPI.sidebarAction('about');
                }
            });
        });
        
        // ‰ªéÊï∞ÊçÆÂàõÂª∫Ê†áÁ≠æÈ°µ
        function createTabFromData(tabData) {
            console.log('ÂàõÂª∫Ê†áÁ≠æÈ°µ:', tabData);
            const tabId = tabData.id;
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Áõ∏Âêå ID ÁöÑÊ†áÁ≠æÈ°µ
            if (tabs.some(tab => tab.id === tabId)) {
                console.log('Ê†áÁ≠æÈ°µÂ∑≤Â≠òÂú®ÔºåË∑≥ËøáÂàõÂª∫:', tabId);
                return;
            }
            
            // ÂàõÂª∫Ê†áÁ≠æÈ°µÂÖÉÁ¥†
            const tab = document.createElement('div');
            tab.className = 'tab';
            tab.dataset.tabId = tabId;
            tab.innerHTML = `
                <span class="tab-title">${tabData.remark}</span>
                <span class="tab-close"></span>
            `;
            
            // ÂàõÂª∫ webview ÂÖÉÁ¥†
            const webviewWrapper = document.createElement('div');
            webviewWrapper.className = 'webview-wrapper';
            webviewWrapper.dataset.tabId = tabId;
            
            const webview = createWebviewElement(tabData);
            
            // Ê∑ªÂä† webview Âä†ËΩΩÂÆåÊàê‰∫ã‰ª∂ÁõëÂê¨
            webview.addEventListener('dom-ready', () => {
                console.log(`webview ${tabData.id} Âä†ËΩΩÂÆåÊàê`);
                // Â¶ÇÊûúÊòØÁ¨¨‰∏Ä‰∏™Ê†áÁ≠æÈ°µÔºåÁ°Æ‰øùÂÆÉÊòæÁ§∫
                if (tabs.length === 1) {
                    webviewWrapper.style.display = 'block';
                }
            });
            
            // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
            tab.addEventListener('click', () => {
                console.log('ÁÇπÂáªÊ†áÁ≠æÈ°µ:', tabId);
                switchTab(tabId, true);  // ÊòéÁ°ÆÊåáÂÆöÊòØÁî®Êà∑ÁÇπÂáª
            });
            tab.addEventListener('dblclick', () => {
                if (window.electronAPI) {
                    window.electronAPI.editTab(tabId);
                }
            });
            tab.querySelector('.tab-close').addEventListener('click', (e) => {
                e.stopPropagation();
                
                // Ê£ÄÊü•ÊòØÂê¶Âè™Ââ©‰∏ã‰∏Ä‰∏™Ê†áÁ≠æÈ°µÔºåÂ¶ÇÊûúÊòØÂàôÁ¶ÅÊ≠¢ÂÖ≥Èó≠
                if (tabs.length <= 1) {
                    alert('Êó†Ê≥ïÂÖ≥Èó≠ÊúÄÂêé‰∏Ä‰∏™Ê†áÁ≠æÈ°µ');
                    return;
                }
                
                if (window.electronAPI) {
                    window.electronAPI.showConfirmDialog('Á°ÆËÆ§ÂÖ≥Èó≠', 'Á°ÆÂÆöË¶ÅÂÖ≥Èó≠Ëøô‰∏™Ê†áÁ≠æÈ°µÂêóÔºü')
                        .then(confirmed => {
                            if (confirmed) {
                                window.electronAPI.removeTab(tabId);
                            }
                        });
                } else {
                    removeTab(tabId);
                }
            });
            
            // Ê∑ªÂä†Âà∞ DOM
            document.getElementById('tabsContainer').insertBefore(tab, document.getElementById('newTabButton'));
            webviewWrapper.appendChild(webview);
            document.getElementById('webviewContainer').appendChild(webviewWrapper);
            
            // Êõ¥Êñ∞Êï∞ÊçÆ
            tabs.push({
                id: tabId,
                element: tab,
                webview: webview,
                data: tabData
            });
            
            console.log('Ê†áÁ≠æÈ°µÂàõÂª∫ÂÆåÊàê:', tabId);
            
            // Â¶ÇÊûúÊòØÁ¨¨‰∏Ä‰∏™Ê†áÁ≠æÈ°µÔºåÊøÄÊ¥ªÂÆÉ
            if (tabs.length === 1) {
                switchTab(tabId);
            }
        }
        
        // ÂàáÊç¢Ê†áÁ≠æÈ°µ
        function switchTab(tabId, isUserClick = false) {
            console.log('ÂàáÊç¢Ê†áÁ≠æÈ°µ:', tabId, isUserClick ? '(Áî®Êà∑ÁÇπÂáª)' : '(ÂàùÂßãÂåñ)');
            // Êõ¥Êñ∞Ê¥ªÂä®Ê†áÁ≠æÈ°µ
            tabs.forEach(tab => {
                if (tab.id === tabId) {
                    tab.element.classList.add('active');
                    tab.webview.parentElement.classList.add('active');
                    tab.webview.parentElement.style.display = 'block';  // Á°Æ‰øùÊòæÁ§∫
                    activeTabId = tabId;
                    
                    // Âè™Âú®Áî®Êà∑ÁÇπÂáªÊó∂ÈÄöÁü•‰∏ªËøõÁ®ãÊõ¥Êñ∞Ê¥ªÂä®ÁöÑwebview
                    if (isUserClick && window.electronAPI) {
                        window.electronAPI.updateActiveWebview(tabId);
                    }
                } else {
                    tab.element.classList.remove('active');
                    tab.webview.parentElement.classList.remove('active');
                    tab.webview.parentElement.style.display = 'none';  // ÈöêËóèÂÖ∂‰ªñÊ†áÁ≠æÈ°µ
                }
            });
        }
        
        // Âà†Èô§Ê†áÁ≠æÈ°µ
        function removeTab(tabId) {
            // ÊâæÂà∞Ë¶ÅÂà†Èô§ÁöÑÊ†áÁ≠æÈ°µ
            const tabIndex = tabs.findIndex(tab => tab.id === tabId);
            if (tabIndex === -1) return;
            
            // ‰ªé DOM ‰∏≠ÁßªÈô§
            tabs[tabIndex].element.remove();
            tabs[tabIndex].webview.parentElement.remove();
            
            // ‰ªéÊï∞ÁªÑ‰∏≠ÁßªÈô§
            tabs.splice(tabIndex, 1);
            
            // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÊ¥ªÂä®ÁöÑÊ†áÁ≠æÈ°µÔºåÊøÄÊ¥ª‰∏ã‰∏Ä‰∏™Ê†áÁ≠æÈ°µ
            if (activeTabId === tabId && tabs.length > 0) {
                switchTab(tabs[0].id);
            }
        }

        // Êõ¥Êñ∞Ê†áÁ≠æÈ°µ
        function updateTab(tabData) {
            // ÊâæÂà∞Ë¶ÅÊõ¥Êñ∞ÁöÑÊ†áÁ≠æÈ°µ
            const tab = tabs.find(tab => tab.id === tabData.id);
            if (!tab) return;
            
            // Êõ¥Êñ∞Ê†áÁ≠æÈ°µÊ†áÈ¢ò
            tab.element.querySelector('.tab-title').textContent = tabData.remark;
            
            // Êõ¥Êñ∞Ê†áÁ≠æÈ°µÊï∞ÊçÆ
            tab.data = tabData;
        }

        // ÊòæÁ§∫ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
        async function showSettingsModal() {
            console.log('ÂºÄÂßãÊòæÁ§∫ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü');
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'settingsModal';
            
            // Ëé∑ÂèñÂΩìÂâçÊ†áÁ≠æÈ°µÊï∞ÊçÆ
            const currentTab = tabs.find(tab => tab.id === activeTabId);
            if (!currentTab) {
                console.error('Ê≤°ÊúâÊâæÂà∞ÂΩìÂâçÊ¥ªÂä®Ê†áÁ≠æÈ°µ');
                return;
            }
            console.log('ÂΩìÂâçÊ†áÁ≠æÈ°µÊï∞ÊçÆ:', currentTab.data);
            console.log('ÂΩìÂâçÊ†áÁ≠æÈ°µ service Â≠óÊÆµ:', currentTab.data.service, 'Á±ªÂûã:', typeof currentTab.data.service);

            // Ëé∑ÂèñÊúçÂä°Êï∞ÊçÆ
            let services = [];
            try {
                console.log('ÂºÄÂßãËØªÂèñÊúçÂä°Êï∞ÊçÆ');
                const serviceData = await window.electronAPI.readServiceData();
                console.log('ËØªÂèñÂà∞ÁöÑÊúçÂä°Êï∞ÊçÆ:', serviceData);
                services = serviceData.services || [];
                console.log('Â§ÑÁêÜÂêéÁöÑÊúçÂä°ÂàóË°®:', services);
            } catch (error) {
                console.error('ËØªÂèñÊúçÂä°Êï∞ÊçÆÂ§±Ë¥•:', error);
            }

            // ÁîüÊàêÈÄâÈ°πHTML
            const optionsHtml = services.map(service => {
                console.log('Â§ÑÁêÜÊúçÂä°È°π:', service);
                // Á°Æ‰øùÁ±ªÂûãÂåπÈÖç
                const serviceId = String(service.id);
                const currentService = String(currentTab.data.service);
                const isSelected = currentTab.data.service && currentService === serviceId;
                console.log('ÊØîËæÉ:', {
                    serviceId,
                    currentService,
                    isSelected
                });
                return `<option value="${serviceId}" ${isSelected ? 'selected' : ''}>${service.group}</option>`;
            }).join('');
            console.log('ÁîüÊàêÁöÑÈÄâÈ°πHTML:', optionsHtml);

            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>ËÆæÁΩÆ</h2>
                    </div>
                    <div class="form-item">
                        <label for="sceneSelect">ÈÄâÊã©Âú∫Êéß</label>
                        <select id="sceneSelect">
                            <option value="">ËØ∑ÈÄâÊã©Âú∫Êéß</option>
                            ${optionsHtml}
                        </select>
                    </div>
                    <div class="button-group">
                        <button class="btn" onclick="cancelSettings()">ÂèñÊ∂à</button>
                        <button class="btn btn-primary" onclick="saveSettings()">‰øùÂ≠ò</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('ËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÂ∑≤Ê∑ªÂä†Âà∞È°µÈù¢');

            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeSettingsModal();
                }
            });
        }

        // ‰øùÂ≠òËÆæÁΩÆ
        async function saveSettings() {
            console.log('‰øùÂ≠òËÆæÁΩÆ');
            const scene = document.getElementById('sceneSelect').value;
            
            if (window.electronAPI) {
                // Ëé∑ÂèñÂΩìÂâçÊ†áÁ≠æÈ°µÊï∞ÊçÆ
                const currentTab = tabs.find(tab => tab.id === activeTabId);
                if (!currentTab) {
                    console.error('Ê≤°ÊúâÊâæÂà∞ÂΩìÂâçÊ¥ªÂä®Ê†áÁ≠æÈ°µ');
                    return;
                }

                // Êõ¥Êñ∞Ê†áÁ≠æÈ°µÊï∞ÊçÆ
                const updatedTab = {
                    ...currentTab.data,
                    // Â¶ÇÊûúÈÄâÊã©ÁöÑÊòØÁ©∫ÂÄºÔºåÂàôËÆæÁΩÆ service ‰∏∫ null
                    service: scene || null
                };

                // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑÊ†áÁ≠æÈ°µÊï∞ÊçÆ
                await window.electronAPI.updateTab(updatedTab);
                
                // Êõ¥Êñ∞Êú¨Âú∞Ê†áÁ≠æÈ°µÊï∞ÊçÆ
                updateTab(updatedTab);
                
                closeSettingsModal();
            }
        }

        // ÂèñÊ∂àËÆæÁΩÆ
        function cancelSettings() {
            console.log('ÂèñÊ∂àËÆæÁΩÆ');
            closeSettingsModal();
        }

        // ÂÖ≥Èó≠ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
        function closeSettingsModal() {
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.remove();
            }
        }

        // ÂàõÂª∫Êñ∞ÁöÑ webview ÂÖÉÁ¥†
        function createWebviewElement(tabData) {
            const webview = document.createElement('webview');
            webview.setAttribute('src', `https://zs.kwaixiaodian.com/page/helper?from=seller_pc_home_page&tabId=${tabData.id}`);
            webview.setAttribute('partition', `persist:${tabData.id}`);
            webview.setAttribute('webpreferences', 'contextIsolation=yes, nodeIntegration=yes');
            webview.setAttribute('allowpopups', '');
            webview.setAttribute('preload', './preload.js');
            webview.setAttribute('id', tabData.id);
            webview.setAttribute('class', 'webview');
            // ÁßªÈô§ÈªòËÆ§ÁöÑ display: none Ê†∑Âºè
            return webview;
        }
    </script>
</body>
</html> 